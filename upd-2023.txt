Когда-то давно я создал тему [url=https://forum.mybb.ru/viewtopic.php?id=37243#p909316]Неглобальные доработки движка MyBB (с предложениями по PHP реализации)[/url], и весь функционал оттуда уже либо был реализован, либо мы решили его не делать, часть их которых делал лично я...

И вот, у меня появилось немного свободного времени летом, и несколько идей по дополнениям движка, которые либо просто давно напрашиваются и реализуются абсолютно костыльными способами, либо просто пришли мне в голову как возможные инструменты для будущих проектов (не только моих, я уверен, другие тоже найдут применения).
И я решил сделать для них отдельную тему, что бы не перегружать предыдущую.

Отдельно упомяну: это [b]проект[/b]. Это значит, что всё, что здесь приведено — это предмет для обсуждения, которые могут быть изменены перед конечной реализации (и, скорее всего, будут). Вы можете оставлять свои предложения и отзывы!

Ну, поехали!

[add] Для отслеживания изменений в этом тексте, я сделал репозиторий [url=https://github.com/kozhilya/mybb-ru-updates]kozhilya/mybb-ru-updates[/url]. В нём будет всё то, что есть здесь, просто можно будет смотреть по изменениям основной ветки, какие изменения были в этим текстом :D

[spoiler="[b]1. Стили[/b] (статус: [b]обсуждение[/b])"]Эти изменения будут полезны, в первую очередь, для форумов, использующие свой стиль с несколькими темами. Огромное количество ролевых форумов используют эту идею, и все реализации в той или иной степени костыльные и не без проблем.

[media="Демонстрация проблемы, которую предлагается решить"][video]https://www.youtube.com/watch?v=qUSXFWVXrlY[/video]
[video]https://www.youtube.com/watch?v=X2Mqy4ath4w[/video]
[/media]

[align=center][b]1.1. Настройки (Администрирование - Свой стиль)[/b][/align]

[ul]
[*] [b]Использовать свой стиль[/b]: да/нет ([i]существует сейчас как поле "Свой стиль"[/i]).
[*] [b]Использовать стандартный extra.css[/b]: да/нет ([i]существует сейчас как опция в "Свой стиль"[/i]).
[*] [b]API-настройка темы стиля[/b] ([color=red][b]Новое[/b][/color]): короткое поле ввода, допустимы только символы латинского алфавита, дефис и подчёркивание (регулярка [h][font=Courier New][a-zA-Z\-_]+[/font][/h]). Настройка отключается, если поле пустое.
[*] [b]Структура style.css[/b] (без изменений)
[*] [b]Структура style_cs.css[/b] (без изменений)
[/ul]

[hr]
[align=center][b]1.2. Темы форума[/b][/align]

Идея в том, что администратор форума может выделить одно из полей API-настроек пользователя так, что бы оно включалось как дата-атрибут тега <body> (возможно сделать к <html>?).

[spoiler="Пример"]Пусть админ введёт в поле "[b]API-настройка темы стиля[/b]" это значение как [color=olive][font=Courier New][b]forum-style[/b][/font][/color], после чего, используя один из распространённых скриптов переключения стиля, устанавливает API-настройку пользователя запросом:
[quote][font=Courier New]/api.php?method=storage.set&token=[color=fuchsia][b]***[/b][/color]&key=[color=olive][b]forum-style[/b][/color]&value=[color=green][b]example_theme[/b][/color][/font][/quote]
Тогда для этого пользователя форум будет генерировать для страниц форума код
[quote][font=Courier New]<body data-[color=olive][b]forum-style[/b][/color]="[color=green][b]example_theme[/b][/color]">...</body>[/font][/quote]
И администратор может стилизовать эту тему, используя префиксом селектор атрибута
[quote][font=Courier New][data-[color=olive][b]forum-style[/b][/color]="[color=green][b]example_theme[/b][/color]"] .post-content { ... }[/font][/quote]
[/spoiler]
Такой метод, будучи довольно простым, позволит стилизовать темы (почти) без использования дополнительного JS (скрипт понадобится для переключения). Но, что важнее, в этом случае нужная тема сможет начать формироваться до того, как начнёт формироваться контент, это позволит избежать "моргания" (см. "Демонстрация проблемы" выше), например, светлого фона по умолчанию, если у пользователя выбрана тёмная тема.

[hr]
[align=center][b]1.3. Дополнительные расширения на обсуждение[/b][/align]
[ul]
[*] [b]Список допустимых значений[/b] — сам по себе мало полезен
[*] [b]Встроенный в движок скрипт переключения стилей[/b] — список допустимых значений теперь поможет сформировать список значений сюда.
[*] [b]Отдельные таблицы стилей для разных тем[/b] — требует сильного изменения бек-енда формирования стилей, я лично не думаю, что это стоит реализовывать.
Речь идёт про использование таблицы [b]style.css[/b] для общих элементов стиля, [b]style_[color=green]example_theme[/color].css[/b] для темы "example_theme", [b]style_[color=green]another_theme[/color].css[/b] для темы "another_theme" и т.д. Потребует список допустимых значений.
[*] [b]Возможность включить ротацию темы по времени[/b] — слишком нишево, потребует использование crontab на бек-енде.
[/ul]
[/spoiler]
 
[spoiler="[b]2. PHP-хуки[/b] (статус: [b]обсуждение[/b])"]Используются для отправки сообщений внешним сервисам о том, что на форуме произошли изменения.

Идея в том, что сейчас скрипты уведомлений и статистик сейчас используют не особо эффективные скрипты для получения информации об информации о новых сообщениях, которое заключается в тупом сканировании раз в N минут содержимого форума... Что может быть как медленно для активных форумов, так и слишком часто для медленных форумов.

Идея в том, что бы сделать систему, аналогичную [url=https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks]Discord[/url] или [url=https://github.com/kozhilya/mybb-april-fools/settings/hooks]Github[/url]... Я ещё подумаю над тем, что бы сделать систему хуков полностью совместимую с этими сервисами, честно, я не задумывался об этом, когда писал черновик :D

[hr]
[align=center][b]2.1. Манифест[/b][/align]

JSON на внешнем сервисе, сообщающий о создателе, его контактах, ссылки для техподдержки и том, какие изменения проверяются внешним сервисом.

Структура:
[ul]
[*] [b]name[/b] — строка, отображаемое в админке название;
[*] [b]description[/b] — строка, описание хука;
[*] [b]link[/b] — строка, ссылка на полное описание;
[*] [b]version[/b] — строка, информация о версии;
[*] [b]author[/b] — строка, имя создателя;
[*] [b]receiver[/b] — строка, полный URL скрипта на внешнем сервисе, который будет обрабатывать входящие хуки;
[*] [b]hooks[/b] — массив строк, содержащий список всех.
[/ul]

[hr]
[align=center][b]2.2. Работа хука[/b][/align]

Хуки бывают 2 видов: перед событием (before) и после него (after). Скорее всего, я пока не планирую хуки перед событием, так как они нужны, что бы заранее изменить входящие данные, и я не вижу, как и зачем это нужно: это можно делать через JS перед отправкой формы

Хук совершает curl-запрос по адресу, указанном в манифесте в поле reciever. Данные передаются методом POST, таймаут запроса 10 секунд.

Данные всегда имеют эти поля, в дополнение к указанным в п. [b]2.3[/b]:
[ul]
[*] [b]forum_id[/b] — число, id форума, посылающего хук;
[*] [b]event[/b] — строка, событие, из-за которого создан хук;
[*] [b]data[/b] — объект, данные о конкретном хуке.
[/ul]

[hr]
[align=center][b]2.3. Хуки[/b][/align]

[b]2.3.1. Создание хука (hook.register)[/b]

Создаётся после того, как хук был зарегистрирован или обновлён в системе

Данные хука: 
[ul]
[*] [b]url[/b] — строка, URL форума (основной домен);
[*] [b]title[/b] — строка, Название форума.
[/ul]

[b]2.3.2. Регистрация пользователя (user.create)[/b]

После регистрации пользователя

Данные хука: 
[ul]
[*] [b]user_id[/b] — число, id нового пользователя.
[/ul]

[b]2.3.3. Изменение пользователя (user.edit)[/b]

После изменения профиля пользователя

Данные хука: 
[ul]
[*] [b]user_id[/b] — число, id изменённого пользователя.
[/ul]

[b]2.3.4. Создание сообщения (message.post)[/b]

После создания нового сообщения

[ul]
[*] [b]post_id[/b] — число, id нового сообщения;
[*] [b]author_id[/b] — число, id автора сообщения;
[*] [b]topic_id[/b] — число, id темы, в котором было создано сообщение;
[*] [b]forum_id[/b] — число, id форума, в котором было создано сообщение.
[/ul]

[b]2.3.5. Редактирование сообщения (message.edit)[/b]

После изменения сообщения (втч перемещения)

Данные хука: 
[ul]
[*] [b]post_id[/b] — число, id изменённого сообщения;
[*] [b]author_id[/b] — число, id автора исходного сообщения;
[*] [b]editor_id[/b] — число, id пользоватлея, редактирующего сообщение;
[*] [b]topic_id[/b] — число, id темы, в котором было создано сообщение;
[*] [b]forum_id[/b] — число, id форума, в котором было создано сообщение.
[/ul]

[b]2.3.6. Удаление сообщения (message.delete)[/b]

После создания нового сообщения

Данные хука: 
[ul]
[*] [b]post_id[/b] — число, id удалённого сообщения.
[/ul]

[b]2.3.7. Оценка сообщения (message.rate)[/b]

После создания нового сообщения

Данные хука: 
[ul]
[*] [b]post_id[/b] — число, id оценённого сообщения;
[*] [b]author_id[/b] — число, id пользователя, чьё сообщение было оценено;
[*] [b]sender_id[/b] — число, id пользователя, кто оценил сообщение$
[*] [b]change[/b] — число, значение оценки (+1 или -1).
[/ul]
[/spoiler]

[spoiler="[b]3. BB-теги[/b] (статус: [b]обсуждение[/b])"][align=center][b]3.1. Исправление: [url=https://forum.mybb.ru/viewtopic.php?pid=985832#p985832]дефис в атрибутах[/url][/b][/align]
[quote="kolobdur74"][b]kozhilya[/b], кстати во время разработки вкладок вв-кодом столкнулся с тем, что не хватает возможности добавления предустановленных атрибутов. Хотел реализовать вкладки через input и label, но пришлось отказаться. Но это так, а вот, то что в классах нельзя использовать дефис или подчеркивание - это неудобно, то есть так работать не будет: [b]acont[div.window.[color=red]active-vkladka[/color]/data-content]:im[/b], а вот так работает: [b]acont[div.window.[color=red]activevkladka[/color]/data-content]:im[/b]. В принципе тоже не критично))[/quote]

[align=center][b]3.2. Исправление: пустые параграфы в заголовках спойлеров[/b][/align]
Проблема возникает в заголовках спойлеров, которые имеют тег [[b]align[/b]]. Это баг из предыдущего изменения, который никто не решился исправить. Что ж, я его породил, мне его и удалять :D

[spoiler="Пример"]Пусть имеется исходный bb-код
[quote][font=Courier New][[b][/b]spoiler="[[b][/b]align=center]Пример[[b][/b]/align]"] ... [[b][/b]/spoiler][/font][/quote]

Парсер его модифицирует как:
[quote][font=Courier New]<div onclick="$(this).toggleClass('visible'); $(this).next().toggleClass('visible');">
[b][color=navy]</p>[/color][/b]
[b][color=purple]<p style="text-align:center;">[/color][/b]Пример[b][color=purple]</p>[/color][/b]
[b][color=green]<p>[/color][/b]
</div>[/font][/quote]
[/spoiler]

[align=center][b]3.3. Тег [[i][/i]kbd][/b][/align]
Для того, что бы вставлять bb-код в строке.
[spoiler="[b]3.3.1. Пример[/b]"]Исходный код:
[code]Используй тег [kbd][b]имя[/b][/kbd], что бы выделить имя жирным.[/code]

HTML-код:
[code]<p>Используй тег <kbd>[b]имя[/b]</kbd>, что бы выделить имя жирным.[/code]
[/spoiler]

Вообще, конечно, <code> был бы корректнее... Но [[b][/b]code] уже занят просто капитально xD

[spoiler="[b]3.3.2. Добавление в форму ответа[/b]"]
[img]https://i.imgur.com/3r53cCE.png[/img]
[/spoiler]

[align=center][b]3.4. Обновление страницы /help.php[/b][/align]
Произвести обновление страницы [url=http://forum.mybb.ru/help.php]/help.php[/url]

[b]3.4.1. Добавить основную вёрстку форума[/b]
... Потому что сейчас её нет. И на кастомных дизайнах это выглядит... [url=https://i.imgur.com/jGtkDKU.png]Странно.[/url]

[b]3.4.2. Обновить со всеми новыми тегами[/b]
Я сам полезу

[b]3.4.3. Возможно[/b]
[ul]
[*] Окно для описания кастомных bb-кодов
[*] Дополнительные страницы и навигация между ними
[/ul]
[/spoiler]


[spoiler="[b]4. Изображение темы[/b] (статус: [b]обсуждение[/b])"]Добавить изображение для темы, которое будет добавляться в meta-теги темы, которая позволит сделать отображение ссылки на тему в социальных сетях и месcенджерах красивее.

Из самой большой проблемы, которую я вижу сейчас: потребуется изменение структуры БД, правда, незначительное: новый столбец в таблице тем, типа "VARCHAR(255)", значение по умолчанию — пустая строка.

[hr]
[align=center][b]4.1. Форма ответа[/b][/align]
При изменении темы, если доступно изменение темы (в частности, есть поле "Название темы") перед формой ответа добавляется дополнительное текстовое поле "Изображение темы".

[hr]
[align=center][b]4.2. Список тем[/b][/align]
[code]<td class="tcl tcl-image">
  <div class="intd">
    <div class="icon"><!-- --></div>
    
    <!-- Новое -->
    <div class="image">
      <img src="https://placehold.co/600x400" alt="Название темы">
    </div>
    <!-- Конец нового -->
    
    <div class="tclcon">
      <span class="acchide">1</span>
      <a href="https://forum.mybb/viewtopic.php?id=123">Название темы</a> 
      <span class="byuser"> kozhilya</span>
    </div>
  </div>
</td>[/code]
[b]tcl-image[/b] — класс для обозначения, что у темы есть изображение.

[hr]
[align=center][b]4.3. Мета-теги[/b][/align]
[code]
<meta property="og:title" content="Название темы">
<meta property="og:url" content="https://forum.mybb/viewtopic.php?id=123">
<!-- Новое -->
<meta property="og:image" content="https://placehold.co/600x400">
<meta property="og:description" content="Тут будут первые 100 символов сообщения, из которого удалены все html-теги, используя php-метод strip_tags">
<meta property="og:type" content="article">
<!-- Конец нового -->
[/code]

[align=center][b]4.4. Основное изображение[/b][/align]
Дополнительное поле в "Администрирование - Настройки" - "Основные".
[ul]
[*] [b]Баннер форума[/b] — Изображение, которое будет добавляться в карточки в мессенджерах, когда вы добавляете ссылку на форум.
[/ul]

Это изображение будет добавляться в <meta property="og:image"> на всех страницах, если на странице нет другого релевантного изображения ()
[/spoiler]

[spoiler="[b]5. Скрипты[/b] (статус: [b]обсуждение[/b])"]Идеи по включению популярных скриптов в "[b]Администрирование - Скрипты[/b]"

[hr]
[align=center][b]5.1. Стрелочки прокрутки[/b][/align]
Популярный скрипт, который используется на многих форумах.

Опции:
[ul]
[*] [b]Показывать стрелку "В конец страницы"[/b] — да/нет;
[*] [b]Всегда показывать стрелки[/b] — да/нет, если "нет", то стрелка "вверх" будет скрываться, если страница прокручена в начало (как на этом форуме).
[/ul]

[hr]
[align=center][b]5.2. Переключение стилей[/b][/align]
В дополнение к обновлению в п. [b]1[/b].

Опции:
[ul]
[*] [b]Список вариантов[/b] — многострочный список, возможно, брать список из "Список допустимых значений" (см. п. [b]1.3[/b]).
[/ul]

[hr]
[align=center][b]5.3. Быстрый вход[/b][/align]
Используется на многих форумах как "PR-вход". Добавляет пункт в pun-navlinks.

Опции:
[ul]
[*] [b]id пользователя[/b] — id-пользователя, быстрый вход в которого будет происходить.
[/ul]

Потребует дополнения в PHP, который позволит вход без ввода пароля... Ну либо добавить опцию "пароль" :D
[/spoiler]

[spoiler="[b]6. API[/b] (статус: [b]обсуждение[/b])"]Набор изменений, предлагаемых в системе API

[align=center][b]6.1. Метод [font=Courier New]boart.setSettings[/font][/b][/align]
Использовать для передачи настроек в JavaScript-переменную, которая будет установлена в <head>.

Параметры:
[ul]
[*] [b]token[/b] — Значение необходимо брать из JavaScript переменной ForumAPITicket. Обязательный параметр.
[*] [b]data[/b] — JSON настроек.
[/ul]

Главная проблема, которую я тут вижу: вопрос безопасности. Какие аккаунты должны иметь право на установку этого значения?
[/spoiler]
